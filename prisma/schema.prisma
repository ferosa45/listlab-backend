generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String         @id @default(uuid())
  email                String         @unique
  password             String
  createdAt            DateTime       @default(now())
  schoolId             String?
  role                 String         @default("TEACHER") // TEACHER | SCHOOL_ADMIN | SUPERADMIN
  stripeCustomerId     String?        @unique
  subscriptionStatus   String? // active, trialing, past_due, canceled...
  subscriptionPlan     String? // basic_monthly, basic_yearly, team
  subscriptionUntil    DateTime?
  school               School?        @relation(fields: [schoolId], references: [id])
  passwordSetupToken   String?        @unique
  passwordSetupExpires DateTime?
  logs                 WorksheetLog[]
  sentInvites          SchoolInvite[] @relation("InvitedBy")
  invoices             Invoice[] // Vztah na faktury
}

model School {
  id                   String         @id @default(uuid())
  name                 String
  createdAt            DateTime       @default(now())
  stripeCustomerId     String?        @unique
  stripeSubscriptionId String?        @unique // pro TEAM pl√°n
  subscriptionStatus   String? // active, trialing, past_due, canceled
  subscriptionPlan     String? // team_monthly, team_yearly
  subscriptionUntil    DateTime?
  seatLimit            Int? // poƒçet uƒçitel≈Ø, nap≈ô. 10 seats
  license              License?
  users                User[]
  invites              SchoolInvite[]
  // üî• FAKTURAƒåN√ç √öDAJE
  billingName          String?
  billingStreet        String?
  billingCity          String?
  billingZip           String?
  billingCountry       String?
  billingIco           String?
  billingDic           String?
  billingEmail         String?
  invoices             Invoice[] // üëà TOTO CHYBƒöLO
}

model License {
  id        String    @id @default(uuid())
  schoolId  String    @unique
  type      String
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  school    School    @relation(fields: [schoolId], references: [id])
}

model Subscription {
  id String @id @default(uuid())

  ownerType String // 'USER' | 'SCHOOL'
  ownerId   String // user.id nebo school.id

  planCode      String // basic_monthly, school_yearly, team_monthly...
  billingPeriod String // monthly, yearly

  stripeCustomerId     String
  stripeSubscriptionId String @unique
  stripePriceId        String

  status             String // active, trialing, past_due, canceled
  cancelAtPeriodEnd  Boolean   @default(false)
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?

  // TEAM license
  seatLimit Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerType, ownerId])
  @@index([stripeCustomerId])
}

model UsageLimit {
  id              String   @id @default(uuid())
  ownerType       String
  ownerId         String
  year            Int
  month           Int
  worksheetsCount Int      @default(0)
  aiGenerations   Int      @default(0)
  updatedAt       DateTime @updatedAt

  @@unique([ownerType, ownerId, year, month])
  @@index([ownerType, ownerId])
}

model WorksheetLog {
  id        String   @id @default(uuid())
  userId    String
  topic     String
  level     String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Invoice {
  id String @id @default(uuid())

  // üîó Stripe vazby
  stripeInvoiceId      String  @unique
  stripeCustomerId     String
  stripeSubscriptionId String?

  // intern√≠ ƒç√≠slo
  number   String @unique
  year     Int
  sequence Int

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  amountPaid Int
  currency   String
  status     String // PAID | DRAFT | CANCELED

  // üî• NOV√â
  periodStart DateTime?
  periodEnd   DateTime?

  issuedAt  DateTime
  createdAt DateTime @default(now())

  // snapshot billing
  billingName    String
  billingStreet  String
  billingCity    String
  billingZip     String
  billingCountry String
  billingIco     String?
  billingEmail   String?
  User           User?   @relation(fields: [userId], references: [id])
  userId         String?

  @@unique([year, sequence])
}

model SchoolInvite {
  id String @id @default(uuid())

  email String
  token String @unique

  schoolId    String
  invitedById String

  role String @default("TEACHER")

  expiresAt  DateTime
  acceptedAt DateTime?
  revokedAt  DateTime?

  createdAt DateTime @default(now())

  school    School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  invitedBy User   @relation("InvitedBy", fields: [invitedById], references: [id])

  @@index([email])
  @@index([schoolId])
}
