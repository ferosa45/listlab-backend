generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String         @id @default(uuid())
  email              String         @unique
  password           String
  createdAt          DateTime       @default(now())
  schoolId           String?
  role               String         @default("TEACHER")   // TEACHER | SCHOOL_ADMIN | SUPERADMIN
  stripeCustomerId   String?        @unique
  subscriptionStatus String?        // active, trialing, past_due, canceled...
  subscriptionPlan   String?        // basic_monthly, basic_yearly, team
  subscriptionUntil  DateTime?
  school             School?        @relation(fields: [schoolId], references: [id])
  passwordSetupToken     String?  @unique
  passwordSetupExpires   DateTime?
  logs               WorksheetLog[]
}

model School {
  id                   String      @id @default(uuid())
  name                 String
  createdAt            DateTime    @default(now())
  stripeCustomerId     String?     @unique
  stripeSubscriptionId String?     @unique   // pro TEAM pl√°n
  subscriptionStatus   String?               // active, trialing, past_due, canceled
  subscriptionPlan     String?               // team_monthly, team_yearly
  subscriptionUntil    DateTime?
  seatLimit            Int?                  // poƒçet uƒçitel≈Ø, nap≈ô. 10 seats
  license              License?
  users                User[]
  // üî• FAKTURAƒåN√ç √öDAJE
  billingName           String?
  billingStreet         String?
  billingCity           String?
  billingZip            String?
  billingCountry        String?
  billingIco            String?
  billingDic            String?
  billingEmail          String?
}

model License {
  id        String    @id @default(uuid())
  schoolId  String    @unique
  type      String
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  school    School    @relation(fields: [schoolId], references: [id])
}

model Subscription {
  id                     String   @id @default(uuid())

  ownerType              String    // 'USER' | 'SCHOOL'
  ownerId                String    // user.id nebo school.id

  planCode               String    // basic_monthly, school_yearly, team_monthly...
  billingPeriod          String    // monthly, yearly

  stripeCustomerId       String
  stripeSubscriptionId   String    @unique
  stripePriceId          String

  status                 String    // active, trialing, past_due, canceled
  cancelAtPeriodEnd      Boolean   @default(false)
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?

  // TEAM license
  seatLimit              Int?

  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  @@index([ownerType, ownerId])
  @@index([stripeCustomerId])
}

model UsageLimit {
  id              String   @id @default(uuid())
  ownerType       String
  ownerId         String
  year            Int
  month           Int
  worksheetsCount Int      @default(0)
  aiGenerations   Int      @default(0)
  updatedAt       DateTime @updatedAt
  @@index([ownerType, ownerId])
  @@unique([ownerType, ownerId, year, month])
}

model WorksheetLog {
  id        String   @id @default(uuid())
  userId    String
  topic     String
  level     String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Invoice {
  id               String   @id @default(uuid())

  // vazby (B2B / B2C)
  schoolId         String?
  userId           String?

  // Stripe reference
  stripeInvoiceId  String
  stripePaymentId String?

  // ƒå√≠slo dokladu
  invoiceNumber    String   // nap≈ô. 2025-0001

  // Datum
  issuedAt         DateTime
  dueAt            DateTime

  // ƒå√°stky (v hal√©≈ô√≠ch)
  currency         String   // CZK
  amountTotal      Int
  amountVat        Int
  vatRate          Int      // 21
  amountNet        Int

  // Odbƒõratel (SNAPSHOT!)
  customerName     String
  customerStreet   String
  customerCity     String
  customerZip      String
  customerCountry  String
  customerIco      String?
  customerEmail    String?

  // Dodavatel (TY ‚Äì snapshot)
  supplierName     String
  supplierIco      String
  supplierStreet   String
  supplierCity     String
  supplierZip      String

  // Typ faktury
  type             String   // subscription | seat_upgrade | etc

  createdAt        DateTime @default(now())

  @@index([schoolId])
  @@index([stripeInvoiceId])
}

